(function(){"use strict";var Javelin=Javelin||{};Javelin.Plugin={},Javelin.Component={},Javelin.Environment={},Javelin.Editor={},Javelin.__componentHandlers={},Javelin.__componentChain={},Javelin.__componentRequirements={},Javelin.register=function(handler){Javelin.__componentHandlers[handler.alias]=handler},Javelin.getComponentHandler=function(name){return Javelin.__componentHandlers[name]||!1},Javelin.getComponentChain=function(name){return Javelin.__componentChain[name]||[]},Javelin.getComponentRequirements=function(){return Javelin.__componentRequirements||[]},Javelin.buildComponentHierarchy=function(){},Javelin.buildComponentRequirements=function(){},Javelin.initialize=function(){for(var name in Javelin.__componentHandlers)Javelin.buildComponentChain(Javelin.__componentHandlers[name]),Javelin.buildComponentRequirements(Javelin.__componentHandlers[name])},Javelin.Asset=function(path){this.path=path,this.loaded=!1},Javelin.Engine=function(environment,config){this.config=config,this.debug=!1,this.environment=environment,this.environment.engine=this,this.reset()},Javelin.Engine.prototype.reset=function(){this.running=!1,this.updating=!1,this.gos=[],this.lastGoId=0,this.step=0,this.time=0,this.prevTime=0,this.deltaTime=0,this.sceneDefinition={},this.plugins=[],this.processConfig(this.config)},Javelin.Engine.prototype.processConfig=function(config){var plugins=config.plugins||[];for(var i in plugins)this.addPlugin(plugins[i]);var opts=config.options||{};for(var j in opts)this.getPlugin(j).$unserialize(opts[j])},Javelin.Engine.prototype.addGameObject=function(go){if(!go.id){go.id=++this.lastGoId,go.engine=this,go.active=!0,this.gos.push(go),this.pluginsAddGameObject(go);for(var cbs=go.getCallbacks("create"),j=0;cbs.length>j;j++)cbs[j]()}},Javelin.Engine.prototype.removeGameObject=function(go){if(go.id){for(var cbs=go.getCallbacks("destroy"),j=0;cbs.length>j;j++)cbs[j]();this.pluginsDestroyGameObject(go),go.id=0;var index=this.gos.indexOf(go);this.gos.splice(index,1)}},Javelin.Engine.prototype.getGameObjectById=function(id){return this.gos[this.goIdMap[id]]||!1},Javelin.Engine.prototype.instantiate=function(def){var go=new Javelin.GameObject;if(go.name=def.name||"Anonymous",def.components)for(var key in def.components){var c=go.addComponent(Javelin.getComponentHandler(key));c.$unserialize(def.components[key])}if(def.children)for(var i in def.children)this.instantiate(def.children[i]);return this.addGameObject(go),go},Javelin.Engine.prototype.initialize=function(){Javelin.initialize()},Javelin.Engine.prototype.run=function(){this.running=!0,this.environment.run()},Javelin.Engine.prototype.stop=function(){this.environment.stop(),this.running=!1},Javelin.Engine.prototype.step=function(){this.running&&(this.updating=!0,this.step++,this.prevStepTime=this.time,this.time=(new Date).getTime(),this.deltaTime=this.time-this.prevStepTime,this.updateGameObjects(this.deltaTime),this.updatePlugins(this.deltaTime),this.updating=!1)},Javelin.Engine.prototype.updateGameObjects=function(deltaTime){for(var i=0;this.gos.length>i;i++)for(var cbs=this.gos[i].getCallbacks("update"),j=0;cbs.length>j;j++)cbs[j](deltaTime)},Javelin.Engine.prototype.updatePlugins=function(deltaTime){for(var plugin in this.plugins)plugin.$active&&plugin.$step(deltaTime)},Javelin.Engine.prototype.pluginsCreateGameObject=function(go){for(var p in this.plugins)this.plugins[p].$onGameObjectCreate(go)},Javelin.Engine.prototype.pluginsDestroyGameObject=function(go){for(var p in this.plugins)this.plugins[p].$onGameObjectDestroy(go)},Javelin.Engine.prototype.loadScene=function(definition,callback){this.resetPlugins(),this.reset();for(var name in definition.plugins)this.getPlugin(name).$unserialize(definition.plugins[name]);for(var i=0;definition.objects.length>i;i++)this.instantiate(definition.objects[i]);callback()},Javelin.Engine.prototype.addPlugin=function(pluginBuilder){var plugin=new Javelin.EnginePlugin;plugin.$alias=pluginBuilder.alias,plugin.$defaults=pluginBuilder.defaults||{},pluginBuilder(this,plugin,pluginBuilder.$defaults),this.plugins.push(plugin)},Javelin.Engine.prototype.resetPlugins=function(){for(var i in this.plugins)this.plugins[i].$reset()},Javelin.Engine.prototype.getPlugin=function(name){for(var i=0;this.plugins.length>i;i++)if(name===this.plugins[i].$alias)return this.plugins[i];return!1},Javelin.EnginePlugin=function(){this.$alias="",this.$defaults={},this.$requirements=[],this.$active=!1,this.$config={}},Javelin.EnginePlugin.prototype.$reset=function(){},Javelin.EnginePlugin.prototype.$onStep=function(){},Javelin.EnginePlugin.prototype.$onGameObjectDestroy=function(){},Javelin.EnginePlugin.prototype.$onGameObjectCreate=function(){},Javelin.EnginePlugin.prototype.$serialize=function(){return this.$config},Javelin.EnginePlugin.prototype.$unserialize=function(data){this.$config=data,this.$reset()},Javelin.Environment=function(){},Javelin.Environment.prototype.initialize=function(){},Javelin.Environment.prototype.validatePlugin=function(){},Javelin.Environment.prototype.run=function(){},Javelin.Environment.prototype.stop=function(){},Javelin.GameObject=function(){this.id=-1,this.name="Untitled",this.engine=null,this.active=!1,this.components={},this.children=[],this.parent=null,this.containedAliases=[],this.hasChanges=!1,this.cbCache={}},Javelin.GameObject.prototype.destroy=function(){this.engine&&this.engine.removeGameObject(this)},Javelin.GameObject.prototype.addComponent=function(componentConstructor){var componentName=componentConstructor.name;if(!this.components[componentName]){this.hasChanges=!0;for(var reqs=Javelin.getRequirementsFor(componentName),l=reqs.length,i=0;l>i;i++)this.addComponent(reqs[i]);var def=new Javelin.GameObjectComponent;def.$id=this.id,def.$go=this;var handlers=Javelin.getComponentHierarchy(componentName);for(l=handlers.length,i=0;l>i;i++)handlers[i](this,def),this.containedAliases[handlers[i].name]=!0;this.components[componentName]=def}},Javelin.GameObject.prototype.getComponent=function(name){return this.components[name]||!1},Javelin.GameObject.prototype.removeComponent=function(name){this.hasChanges=!0,this.components[name]=null},Javelin.GameObject.prototype.instanceOf=function(alias){return this.containedAliases[alias]||!1},Javelin.GameObject.prototype.getComponentsInChildren=function(name){for(var components=[],i=0;this.children.length>i;i++){var c=this.children[i];if(c.children)for(var comps=c.getComponentsInChildren(name),j=0;comps.length>j;j++)components.push(comps[j]);var component=c.getComponent(name);component&&components.push(component)}return components},Javelin.GameObject.prototype.addChild=function(child){this.hasChanges=!0,child.hasChanges=!0,child.parent=this,this.children.push(child)},Javelin.GameObject.prototype.setParent=function(parent){this.hasChanges=!0,parent.hasChanges=!0,parent.addChild(this)},Javelin.GameObject.prototype.removeChild=function(child){child.hasChanges=!0,this.hasChanges=!0,child.parent=null,this.children.splice(this.children.indexOf(child),1)},Javelin.GameObject.prototype.abandon=function(){for(var i=0;this.children.length>i;i++)this.removeChild(this.children[i])},Javelin.GameObject.prototype.getCallbacks=function(eventName,recursive){var cbs=[];for(var comp in this.components){var cb=comp.$getCallback(eventName);cb&&(cb.$id=this.id,cbs.push(cb))}if(recursive)for(var i=0;this.children.length>i;i++){var nestedCBs=this.children[i].getCallbacks(eventName,recursive);for(var j in nestedCBs)cbs.push(nestedCBs[j])}return cbs},Javelin.GameObject.prototype.serialize=function(){var serialized={name:this.name};for(var alias in this.components)serialized[alias]=this.components[alias].$serialize();return serialized},Javelin.GameObject.prototype.unserialize=function(data){if(data.name&&(this.name=data.name),data.components)for(var alias in data.components)this.addComponent(Javelin.getComponentHandler(alias)),this.components[alias].$unserialize(data.components[alias])},Javelin.GameObjectComponent=function(){this.$callbacks={},this.$go={},this.$id=0,this.$alias="",this.$inheritedAliases=[]},Javelin.GameObjectComponent.prototype.$on=function(name,callback){callback.$id=this.$id,this.$callbacks[name]=callback},Javelin.GameObjectComponent.prototype.$getCallback=function(name){return this.$callbacks[name]||!1},Javelin.GameObjectComponent.prototype.$serialize=function(){var data={};for(var key in this)"function"!=typeof this[key]&&"$"!==key.charAt(0)&&(data[key]=this[key]);return data},Javelin.GameObjectComponent.prototype.$unserialize=function(data){for(var key in data)this[key]=data[key]},Javelin.Component.Renderer3d=function(go,comp){go.getComponent("transform3d"),comp.material={},comp.geometry={},comp.mesh={},comp.getMesh=function(){return comp.mesh=new THREE.mesh(comp.geometry,comp.material),comp.mesh.useQuaternion=!0,comp.mesh}},Javelin.Component.Renderer3d.alias="renderer3d",Javelin.Component.Renderer3d.requires=[Javelin.Component.Transform3d],Javelin.register(Javelin.Component.Renderer3d),Javelin.Component.Rigidbody3d=function(go){go.getComponent("transform3d")},Javelin.Component.Rigidbody3d.alias="rigidbody3d",Javelin.Component.Rigidbody3d.requires=[Javelin.Component.Transform3d],Javelin.Component.Transform3d=function(go,comp){comp.position={x:0,y:0,z:0},comp.rotation={x:0,y:0,z:0,w:0},comp.scale=1;var parentTransform=go.parent?go.parent.getComponent("transform3d"):!1;comp.getWorldX=function(){return parentTransform?parentTransform.position.x+comp.position.x:comp.position.x},comp.getWorldY=function(){return parentTransform?parentTransform.position.y+comp.position.y:comp.position.y},comp.getWorldZ=function(){return parentTransform?parentTransform.position.z+comp.position.z:comp.position.z},comp.getPositionVector=function(){return[comp.position.x,comp.position.y,comp.position.z]},comp.getRotationVector=function(){return[comp.rotation.x,comp.rotation.y,comp.rotation.z,comp.rotation.w]},comp.translate=function(arr){comp.position.x+=arr[0],comp.position.y+=arr[1],comp.position.z+=arr[2]},comp.lookAt=function(){}},Javelin.Component.Transform3d.alias="transform3d",Javelin.register(Javelin.Component.Transform3d),Javelin.Environment.Browser=function(){this.engine={}},Javelin.Environment.Browser.prototype=new Javelin.Environment,Javelin.Environment.Browser.prototype.run=function(){window.requestAnimationFrame(this.run);try{this.engine.step()}catch(e){console.log(e)}},Javelin.Environment.Server=function(){this.engine={}},Javelin.Environment.Server.prototype=new Javelin.Environment,Javelin.Environment.Server.prototype.run=function(){},Javelin.Plugin.ThreeJs=function(engine,plugin,config){plugin.config=config,plugin.scene={},plugin.renderer={},plugin.activeCamera={},plugin.$initialize=function(){plugin.$reset()},plugin.$reset=function(){plugin.scene=new THREE.Scene,plugin.renderer=new THREE.WebGLRenderer,plugin.config.renderer.element?plugin.renderer.setSize(plugin.config.renderer.element.innerWidth,plugin.config.renderer.element.innerHeight):plugin.renderer.setSize(plugin.config.renderer.width,plugin.config.renderer.height),plugin.activeCamera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),plugin.activeCamera.position.z=5},plugin.$loadScene=function(){plugin.$reset()},plugin.$onGameObjectDestroy=function(go){var c=go.getComponent("renderer3d");c&&plugin.scene.remove(c.mesh)},plugin.$onGameObjectCreate=function(go){var c=go.getComponent("renderer3d");c&&plugin.scene.add(c.getMesh())},plugin.$step=function(deltaTime){var gos=engine.gos;if(deltaTime>=1e3/plugin.config.stepsPerSecond){for(var i=0;gos.length>i;i++){var c=gos[i].getComponent("renderer3d")||!1;c&&(gos[i].active?(c.mesh.visible=!0,c.mesh.position=gos[i].components.transform3d.position,c.mesh.rotation=gos[i].components.transform3d.rotation):c.mesh.visible=!1)}plugin.renderer.render(plugin.scene,plugin.activeCamera)}},plugin.useCamera=function(){}},Javelin.Plugin.ThreeJs.alias="threejs",Javelin.Plugin.ThreeJs.defaults={renderer:{type:"webgl",height:600,width:800,element:null}},"undefined"!=typeof module?module.exports=Javelin:this.Javelin=Javelin}).apply(this);