(function(){var Javelin=Javelin||{};Javelin.Plugin={},Javelin.Component={};var Javelin=Javelin||{};Javelin.Plugin={},Javelin.Component={},Javelin.Engine=function(config){this.config=config,this.reset()},Javelin.Engine.prototype.reset=function(){this.stopped=!1,this.gos=[],this.goIdMap={},this.lastGoId=0,this.step=0,this.time=0,this.prevTime=0,this.deltaTime=0,this.sceneDefinition={},this.plugins=[],this.processConfig(this.config)},Javelin.Engine.prototype.addGameObject=function(go){go.id||(go.id=++this.lastGoId,go.engine=this,go.active=!0,this.gos.push(go),this.pluginsAddGameObject(go))},Javelin.Engine.prototype.destroyGameObject=function(go){if(go.id){this.pluginsDestroyGameObject(go),this.goIdMap[go.id]=null;var index=this.gos.indexOf(go);this.gos.splice(index,1)}},Javelin.Engine.prototype.getGameObjectById=function(id){return this.gos[this.goIdMap[id]]||!1},Javelin.Engine.prototype.step=function(){this.step++,this.prevStepTime=this.time,this.time=(new Date).getTime(),this.deltaTime=this.time-this.prevStepTime,this.updateGameObjects(this.deltaTime),this.updatePlugins()},Javelin.Engine.prototype.updateGameObjects=function(deltaTime){for(var i=0;this.gos.length>i;i++)for(var cbs=this.gos[i].getCallbacks("update"),j=0;cbs.length>j;j++)cbs[j](deltaTime)},Javelin.Engine.prototype.loadScene=function(definition,callback){this.pluginsReset(),this.reset(),this.environment.$onBeforeSceneLoad(definition);for(var plugin in definition.plugins)this.plugins[plugin]={};this.environment.$onAfterSceneLoad(definition),callback()},Javelin.Engine.prototype.run=function(){this.environment.run()},Javelin.EnginePlugin=function(){},Javelin.EnginePlugin.prototype.$onStep=function(){},Javelin.EnginePlugin.prototype.$onGameObjectDestroy=function(){},Javelin.EnginePlugin.prototype.$onGameObjectCreate=function(){},Javelin.EnginePlugin.prototype.$serialize=function(){},Javelin.EnginePlugin.prototype.$unserialize=function(){},Javelin.GameObject=function(){this.id=-1,this.name="Untitled",this.engine=null,this.active=!1,this.components={},this.children=[],this.parent=null,this.callbacks={}},Javelin.GameObject.prototype.destroy=function(){this.engine&&this.engine.removeGameObject(this)},Javelin.GameObject.prototype.addComponent=function(componentConstructor){var def=new Javelin.GameObjectComponent;componentConstructor(this,def),def.$go=this,this.components[componentConstructor.name]=def},Javelin.GameObject.prototype.getComponent=function(name){return this.components[name]||!1},Javelin.GameObject.prototype.removeComponent=function(name){this.components[name]=null},Javelin.GameObject.prototype.getComponentsInChildren=function(name){for(var components=[],i=0;this.children.length>i;i++){var c=this.children[i];if(c.children)for(var comps=c.getComponentsInChildren(name),j=0;comps.length>j;j++)components.push(comps[j]);var component=c.getComponent(name);component&&components.push(component)}return components},Javelin.GameObject.prototype.addChild=function(child){child.parent=this,this.children.push(child)},Javelin.GameObject.prototype.setParent=function(parent){parent.addChild(this)},Javelin.GameObject.prototype.removeChild=function(child){child.parent=null,this.children.splice(this.children.indexOf(child),1)},Javelin.GameObject.prototype.abandon=function(){for(var i=0;this.children.length>i;i++)this.removeChild(this.children[i])},Javelin.GameObject.prototype.on=function(){},Javelin.GameObject.prototype.getCallbacks=function(eventName){var cbs=this.callbacks[eventName]||[];for(var comp in this.components){var cb=comp.$getCallback(eventName);cb&&(cb.$id=this.id,cbs.push(cb))}return cbs},Javelin.GameObject.prototype.serialize=function(){},Javelin.GameObject.prototype.unserialize=function(data){data.plugins},Javelin.GameObjectComponent=function(){this.$callbacks={},this.$go=null},Javelin.GameObjectComponent.prototype.$on=function(name,callback){this.$callbacks[name]=callback},Javelin.GameObjectComponent.prototype.$getCallback=function(name){return this.$callbacks[name]||!1},Javelin.GameObjectComponent.prototype.$serialize=function(){var data={};for(var key in this)"function"!=typeof this[key]&&"$"!==key.charAt(0)&&(data[key]=this[key]);return data},Javelin.GameObjectComponent.prototype.$unserialize=function(data){for(var key in data)this[key]=data[key]},Javelin.Component.Transform3d=function(go,comp){this.name="transform3d",this.requiredPlugins=["ThreeJs"],comp.position={x:0,y:0,z:0},comp.rotation={x:0,y:0,z:0,quaternion:0};var parentTransform=go.parent?go.parent.getComponent("transform3d"):!1;comp.position.worldX=function(){return parentTransform?parentTransform.position.x+comp.position.x:comp.position.x},comp.position.worldY=function(){},comp.position.worldZ=function(){},comp.rotation.worldX=function(){},comp.rotation.worldY=function(){},comp.rotation.worldZ=function(){}},Javelin.Plugin.ThreeJs=function(engine,config,plugin){plugin.config=config,plugin.scene={},plugin.init=function(){},plugin.onGameObjectDestroy=function(go){{go.getComponent("transform3d")}},plugin.onGameObjectCreate=function(go){{go.getComponent("transform3d")}},plugin.step=function(deltaTime){if(deltaTime>=1e3/config.stepsPerSecond)for(var go in engine.gos)go.active}},"undefined"!=typeof module?module.exports=Javelin:this.Javelin=Javelin}).apply(this);